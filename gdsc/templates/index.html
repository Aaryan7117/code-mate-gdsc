<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Mate</title>
    <style>
        :root {
    --bg-primary: #ffffff;
    --bg-secondary: #f7f7f8;
    --text-primary: #343541;
    --text-secondary: #6e6e80;
    --border-color: #e5e5e5;
    --accent-color: #10a37f;
    --accent-hover: #0d8c6d;
    --danger-color: #e53e3e;
    --danger-hover: #c53030;
    --sidebar-width: 260px;
    --message-user-bg: #f7f7f8;
    --message-ai-bg: #ffffff;
    --shadow-color: rgba(0, 0, 0, 0.05);
    --code-bg: #2d2d2d;
    --code-color: #f8f8f2;
    --code-header-bg: #1e1e1e;
    --gradient-start: #10a37f;
    --gradient-end: #0d8c6d;
}

.dark {
    --bg-primary: #343541;
    --bg-secondary: #444654;
    --text-primary: #ececf1;
    --text-secondary: #c5c5d2;
    --border-color: #4d4d4f;
    --accent-color: #19c37d;
    --accent-hover: #1bd88a;
    --danger-color: #f56565;
    --danger-hover: #e53e3e;
    --message-user-bg: #444654;
    --message-ai-bg: #343541;
    --shadow-color: rgba(0, 0, 0, 0.3);
    --code-bg: #1a1a1a;
    --code-color: #f0f0f0;
    --code-header-bg: #0f0f0f;
    --gradient-start: #19c37d;
    --gradient-end: #1bd88a;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.5;
    transition: background-color 0.3s, color 0.3s;
}

.app-container {
    display: flex;
    height: 100vh;
    width: 100%;
    overflow: hidden;
}

/* Sidebar Styles */
.sidebar {
    width: var(--sidebar-width);
    background-color: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
}

.sidebar-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.new-chat-btn {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 10px 14px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.2s;
}

.new-chat-btn:hover {
    background-color: var(--accent-hover);
}

.toggle-theme-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
}

.toggle-theme-btn:hover {
    background-color: var(--border-color);
}

.chat-history {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
}

.history-item {
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    color: var(--text-secondary);
    position: relative;
}

.history-item:hover {
    background-color: var(--border-color);
}

.history-item.active {
    background-color: var(--border-color);
    color: var(--text-primary);
    font-weight: 500;
}

.history-item svg {
    margin-right: 8px;
}

.history-item-title {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.delete-chat-btn {
    opacity: 0;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: opacity 0.2s, color 0.2s;
}

.history-item:hover .delete-chat-btn {
    opacity: 1;
}

.delete-chat-btn:hover {
    color: var(--danger-color);
}

/* User profile in sidebar */
.user-profile {
    padding: 16px;
    border-top: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--accent-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    overflow: hidden;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-info {
    flex: 1;
    overflow: hidden;
}

.user-name {
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-streak {
    display: flex;
    align-items: center;
    gap: 4px;
    color: var(--text-secondary);
    font-size: 12px;
}

.streak-flame {
    color: #ff6b00;
}

.user-actions {
    display: flex;
    gap: 8px;
}

.user-action-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}

.user-action-btn:hover {
    color: var(--accent-color);
}

/* Main Chat Area Styles */
.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.chat-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
}

.toggle-sidebar-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    margin-right: 16px;
    padding: 4px;
    border-radius: 4px;
    display: none;
}

.toggle-sidebar-btn:hover {
    background-color: var(--border-color);
}

.chat-header h1 {
    font-size: 18px;
    font-weight: 600;
}

.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
}

.welcome-message {
    text-align: center;
    margin: auto;
    max-width: 600px;
}

.welcome-message h2 {
    margin-bottom: 24px;
    font-size: 32px;
    font-weight: 600;
}

.suggestion-chips {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 12px;
    margin-top: 24px;
}

.suggestion-chip {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 10px 16px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s;
    color: var(--text-primary);
}

.suggestion-chip:hover {
    background-color: var(--border-color);
}

.message {
    max-width: 80%;
    margin-bottom: 24px;
    animation: fadeIn 0.3s;
    display: flex;
    flex-direction: column;
}

.message-user {
    align-self: flex-end;
    background-color: var(--message-user-bg);
    border-radius: 12px 12px 0 12px;
    padding: 12px 16px;
}

.message-ai {
    align-self: flex-start;
    background-color: var(--message-ai-bg);
    border-radius: 12px 12px 12px 0;
    padding: 12px 16px;
    box-shadow: 0 2px 6px var(--shadow-color);
}

/* Enhanced message content styling */
.message-content ul, .message-content ol {
    padding-left: 20px;
    margin: 10px 0;
}

.message-content ul li, .message-content ol li {
    margin-bottom: 8px;
    position: relative;
}

.message-content ul li::before {
    content: "•";
    color: var(--accent-color);
    font-weight: bold;
    position: absolute;
    left: -15px;
}

.message-content p {
    margin-bottom: 10px;
}

.message-content p:last-child {
    margin-bottom: 0;
}

/* Code block styling */
.code-container {
    margin: 10px 0;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 2px 6px var(--shadow-color);
}

.code-header {
    background-color: var(--code-header-bg);
    color: var(--text-secondary);
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
}

.language-tag {
    font-family: monospace;
}

.copy-btn, .run-code-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    transition: background-color 0.2s;
    position: relative;
}

.code-header-actions {
    display: flex;
    gap: 8px;
}

.copy-btn:hover, .run-code-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.copy-btn.copied {
    color: var(--accent-color);
}

.code-block {
    background-color: var(--code-bg);
    color: var(--code-color);
    padding: 12px;
    margin: 0;
    overflow-x: auto;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
    white-space: pre;
}

.code-output {
    background-color: #000;
    color: #0f0;
    padding: 12px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
    white-space: pre-wrap;
    border-top: 1px solid #333;
    max-height: 200px;
    overflow-y: auto;
    display: none;
}

.typing-indicator {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background-color: var(--message-ai-bg);
    border-radius: 12px 12px 12px 0;
    align-self: flex-start;
    box-shadow: 0 2px 6px var(--shadow-color);
    margin-bottom: 24px;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    margin: 0 2px;
    background-color: var(--text-secondary);
    border-radius: 50%;
    display: inline-block;
    animation: typing 1.4s infinite both;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0% { transform: scale(1); }
    50% { transform: scale(1.5); }
    100% { transform: scale(1); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.input-container {
    padding: 16px;
    border-top: 1px solid var(--border-color);
}

.input-box {
    display: flex;
    align-items: flex-end;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px 16px;
    margin-bottom: 8px;
}

.input-box textarea {
    flex: 1;
    border: none;
    background: transparent;
    resize: none;
    max-height: 200px;
    min-height: 24px;
    padding: 8px 0;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 16px;
    outline: none;
}

.input-box textarea::placeholder {
    color: var(--text-secondary);
}

.input-buttons {
    display: flex;
    align-items: center;
}

.upload-btn, .send-btn, .voice-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    margin-left: 8px;
}

.upload-btn:hover, .send-btn:hover, .voice-btn:hover {
    color: var(--accent-color);
    background-color: var(--border-color);
}

.voice-btn.recording {
    color: var(--danger-color);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.disclaimer {
    text-align: center;
    color: var(--text-secondary);
    font-size: 12px;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background-color: var(--bg-primary);
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.modal-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 18px;
    font-weight: 600;
}

.close-modal-btn, .close-delete-modal-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}

.modal-body {
    padding: 16px;
}

.file-drop-area {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 32px 16px;
    text-align: center;
    cursor: pointer;
    margin-bottom: 16px;
    transition: border-color 0.2s;
}

.file-drop-area:hover {
    border-color: var(--accent-color);
}

.file-input {
    display: none;
}

.file-list {
    max-height: 200px;
    overflow-y: auto;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
}

.file-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.remove-file-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}

.modal-footer {
    padding: 16px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.cancel-upload-btn, .confirm-upload-btn, .cancel-delete-btn, .confirm-delete-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
}

.cancel-upload-btn, .cancel-delete-btn {
    background-color: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.confirm-upload-btn {
    background-color: var(--accent-color);
    border: none;
    color: white;
}

.confirm-upload-btn:hover {
    background-color: var(--accent-hover);
}

.confirm-delete-btn {
    background-color: var(--danger-color);
    border: none;
    color: white;
}

.confirm-delete-btn:hover {
    background-color: var(--danger-hover);
}

/* Error message */
.error-message {
    background-color: var(--danger-color);
    color: white;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 16px;
    text-align: center;
    animation: fadeIn 0.3s;
}

/* Feedback buttons */
.feedback-container {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 8px;
}

.feedback-btn {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 16px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
}

.feedback-btn:hover {
    background-color: var(--bg-secondary);
    transform: scale(1.05);
}

.feedback-btn.active {
    color: var(--accent-color);
    border-color: var(--accent-color);
}

.feedback-btn.negative.active {
    color: var(--danger-color);
    border-color: var(--danger-color);
}

/* Auth pages */
.auth-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
    background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
}

.auth-card {
    background-color: var(--bg-primary);
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    width: 100%;
    max-width: 400px;
    padding: 32px;
}

.auth-logo {
    text-align: center;
    margin-bottom: 24px;
}

.auth-logo h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--accent-color);
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 500;
    color: var(--text-primary);
}

.form-group input {
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 16px;
    color: var(--text-primary);
    background-color: var(--bg-secondary);
    transition: border-color 0.2s;
}

.form-group input:focus {
    outline: none;
    border-color: var(--accent-color);
}

.auth-btn {
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 12px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
    margin-top: 8px;
}

.auth-btn:hover {
    background-color: var(--accent-hover);
}

.auth-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.auth-divider {
    display: flex;
    align-items: center;
    margin: 24px 0;
    color: var(--text-secondary);
}

.auth-divider::before,
.auth-divider::after {
    content: "";
    flex: 1;
    border-bottom: 1px solid var(--border-color);
}

.auth-divider span {
    padding: 0 10px;
}

.social-auth {
    display: flex;
    gap: 12px;
}

.social-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.social-btn:hover {
    background-color: var(--bg-secondary);
}

.auth-footer {
    text-align: center;
    margin-top: 24px;
    color: var(--text-secondary);
}

.auth-link {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
}

.auth-link:hover {
    text-decoration: underline;
}

.auth-error {
    background-color: rgba(229, 62, 62, 0.1);
    color: var(--danger-color);
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 16px;
    font-size: 14px;
}

/* Profile picture upload */
.profile-upload {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.profile-preview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background-color: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
    cursor: pointer;
}

.profile-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-preview-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
}

.profile-preview:hover .profile-preview-overlay {
    opacity: 1;
}

.profile-upload-input {
    display: none;
}

.profile-upload-label {
    color: var(--text-secondary);
    font-size: 14px;
    cursor: pointer;
}

.profile-upload-label:hover {
    color: var(--accent-color);
}

/* Settings modal */
.settings-section {
    margin-bottom: 24px;
}

.settings-section h3 {
    margin-bottom: 12px;
    font-size: 16px;
    font-weight: 600;
}

.settings-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
}

.settings-option:last-child {
    border-bottom: none;
}

.settings-option-label {
    font-weight: 500;
}

.settings-option-description {
    color: var(--text-secondary);
    font-size: 14px;
    margin-top: 4px;
}

/* Toggle switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border-color);
    transition: .4s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--accent-color);
}

input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

/* Color theme selector */
.color-themes {
    display: flex;
    gap: 12px;
    margin-top: 12px;
}

.color-theme {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s;
}

.color-theme:hover {
    transform: scale(1.1);
}

.color-theme.active {
    border-color: var(--text-primary);
}

.color-theme-green {
    background: linear-gradient(135deg, #10a37f 0%, #0d8c6d 100%);
}

.color-theme-blue {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
}

.color-theme-purple {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.color-theme-red {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.color-theme-orange {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
}

/* Share chat modal */
.share-link-container {
    display: flex;
    margin-top: 16px;
}

.share-link-input {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px 0 0 6px;
    font-size: 14px;
    color: var(--text-primary);
    background-color: var(--bg-secondary);
}

.share-link-copy {
    padding: 10px 16px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 0 6px 6px 0;
    cursor: pointer;
    font-weight: 500;
}

.share-link-copy:hover {
    background-color: var(--accent-hover);
}

.share-options {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}

.share-option {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.share-option:hover {
    background-color: var(--bg-secondary);
}

/* Responsive Styles */
@media (max-width: 768px) {
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
    }
    
    .sidebar.show {
        transform: translateX(0);
    }
    
    .toggle-sidebar-btn {
        display: block;
    }
    
    .message {
        max-width: 90%;
    }
}
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-icons@0.284.0/dist/umd/lucide.min.js">
</head>
<body>
    <div id="app">
        <!-- Auth pages will be dynamically inserted here -->
        <!-- Main app will be shown after authentication -->
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZfmVfAafAHMdmX3K0CRkfBjAHOoDq5jQ",
            authDomain: "code-mate-67c77.firebaseapp.com",
            projectId: "code-mate-67c77",
            storageBucket: "code-mate-67c77.firebasestorage.app",
            messagingSenderId: "308994256026",
            appId: "1:308994256026:web:ba8920268deb4dc8628323"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // DOM Elements
        const appContainer = document.getElementById("app");

        // App State
        let currentUser = null;
        let currentChatId = null;
        let isTyping = false;
        let uploadedFiles = [];
        let chatToDelete = null;
        let userStreak = 0;
        let lastLoginDate = null;
        let selectedTheme = "green";
        
        // Local storage for chats
        let chats = [];
        let chatMessages = {};

        // Initialize App
        document.addEventListener("DOMContentLoaded", initializeApp);

        function initializeApp() {
            // Check authentication state
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    loadUserData();
                    loadLocalChats();
                    renderMainApp();
                } else {
                    // User is signed out
                    renderLoginPage();
                }
            });
        }

        // Load chats from local storage
        function loadLocalChats() {
            const savedChats = localStorage.getItem(`chats_${currentUser.uid}`);
            if (savedChats) {
                chats = JSON.parse(savedChats);
            }
            
            const savedMessages = localStorage.getItem(`messages_${currentUser.uid}`);
            if (savedMessages) {
                chatMessages = JSON.parse(savedMessages);
            }
        }

        // Save chats to local storage
        function saveLocalChats() {
            localStorage.setItem(`chats_${currentUser.uid}`, JSON.stringify(chats));
            localStorage.setItem(`messages_${currentUser.uid}`, JSON.stringify(chatMessages));
        }

        // Auth Pages
        function renderLoginPage() {
            appContainer.innerHTML = `
                <div class="auth-container">
                    <div class="auth-card">
                        <div class="auth-logo">
                            <h1>Code Mate</h1>
                        </div>
                        <div id="auth-error" class="auth-error" style="display: none;"></div>
                        <form id="login-form" class="auth-form">
                            <div class="form-group">
                                <label for="login-email">Email</label>
                                <input type="email" id="login-email" placeholder="Enter your email" required>
                            </div>
                            <div class="form-group">
                                <label for="login-password">Password</label>
                                <input type="password" id="login-password" placeholder="Enter your password" required>
                            </div>
                            <button type="submit" class="auth-btn" id="login-btn">Log In</button>
                        </form>
                        <div class="auth-divider">
                            <span>OR</span>
                        </div>
                        <div class="social-auth">
                            <button class="social-btn" id="google-auth-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.467 0 8.529-3.249 8.529-8.934 0-.528-.081-1.097-.202-1.625z"></path></svg>
                                Google
                            </button>
                            <button class="social-btn" id="github-auth-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                                GitHub
                            </button>
                        </div>
                        <div class="auth-footer">
                            Don't have an account? <a class="auth-link" id="signup-link">Sign Up</a>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners
            document.getElementById("login-form").addEventListener("submit", handleLogin);
            document.getElementById("google-auth-btn").addEventListener("click", handleGoogleAuth);
            document.getElementById("github-auth-btn").addEventListener("click", handleGitHubAuth);
            document.getElementById("signup-link").addEventListener("click", renderSignupPage);
        }

        function renderSignupPage() {
            appContainer.innerHTML = `
                <div class="auth-container">
                    <div class="auth-card">
                        <div class="auth-logo">
                            <h1>Code Mate</h1>
                        </div>
                        <div id="auth-error" class="auth-error" style="display: none;"></div>
                        <form id="signup-form" class="auth-form">
                            <div class="profile-upload">
                                <div class="profile-preview" id="profile-preview">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                    <div class="profile-preview-overlay">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                                    </div>
                                </div>
                                <input type="file" id="profile-upload" class="profile-upload-input" accept="image/*">
                                <label for="profile-upload" class="profile-upload-label">Upload profile picture</label>
                            </div>
                            <div class="form-group">
                                <label for="signup-username">Username</label>
                                <input type="text" id="signup-username" placeholder="Choose a username" required>
                            </div>
                            <div class="form-group">
                                <label for="signup-email">Email</label>
                                <input type="email" id="signup-email" placeholder="Enter your email" required>
                            </div>
                            <div class="form-group">
                                <label for="signup-password">Password</label>
                                <input type="password" id="signup-password" placeholder="Create a password" required minlength="6">
                            </div>
                            <button type="submit" class="auth-btn" id="signup-btn">Sign Up</button>
                        </form>
                        <div class="auth-divider">
                            <span>OR</span>
                        </div>
                        <div class="social-auth">
                            <button class="social-btn" id="google-auth-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.467 0 8.529-3.249 8.529-8.934 0-.528-.081-1.097-.202-1.625z"></path></svg>
                                Google
                            </button>
                            <button class="social-btn" id="github-auth-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                                GitHub
                            </button>
                        </div>
                        <div class="auth-footer">
                            Already have an account? <a class="auth-link" id="login-link">Log In</a>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners
            document.getElementById("signup-form").addEventListener("submit", handleSignup);
            document.getElementById("google-auth-btn").addEventListener("click", handleGoogleAuth);
            document.getElementById("github-auth-btn").addEventListener("click", handleGitHubAuth);
            document.getElementById("login-link").addEventListener("click", renderLoginPage);
            
            // Profile picture preview
            const profileUpload = document.getElementById("profile-upload");
            const profilePreview = document.getElementById("profile-preview");
            
            profileUpload.addEventListener("change", function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profilePreview.innerHTML = `
                            <img src="${e.target.result}" alt="Profile Preview">
                            <div class="profile-preview-overlay">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                            </div>
                        `;
                    }
                    reader.readAsDataURL(file);
                }
            });
            
            profilePreview.addEventListener("click", function() {
                profileUpload.click();
            });
        }

        // Auth Handlers
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            const loginBtn = document.getElementById("login-btn");
            const errorElement = document.getElementById("auth-error");
            
            try {
                loginBtn.disabled = true;
                loginBtn.textContent = "Logging in...";
                errorElement.style.display = "none";
                
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state change will trigger app rendering
            } catch (error) {
                errorElement.textContent = error.message;
                errorElement.style.display = "block";
                loginBtn.disabled = false;
                loginBtn.textContent = "Log In";
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            
            const username = document.getElementById("signup-username").value;
            const email = document.getElementById("signup-email").value;
            const password = document.getElementById("signup-password").value;
            const profileUpload = document.getElementById("profile-upload").files[0];
            const signupBtn = document.getElementById("signup-btn");
            const errorElement = document.getElementById("auth-error");
            
            try {
                signupBtn.disabled = true;
                signupBtn.textContent = "Creating account...";
                errorElement.style.display = "none";
                
                // Create user account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Upload profile picture if provided
                let photoURL = null;
                if (profileUpload) {
                    const storageRef = storage.ref(`profile_pictures/${user.uid}`);
                    await storageRef.put(profileUpload);
                    photoURL = await storageRef.getDownloadURL();
                }
                
                // Update user profile
                await user.updateProfile({
                    displayName: username,
                    photoURL: photoURL
                });
                
                // Create user document in Firestore
                await db.collection("users").doc(user.uid).set({
                    username: username,
                    email: email,
                    photoURL: photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    streak: 0,
                    lastLoginDate: firebase.firestore.FieldValue.serverTimestamp(),
                    theme: "green"
                });
                
                // Auth state change will trigger app rendering
            } catch (error) {
                errorElement.textContent = error.message;
                errorElement.style.display = "block";
                signupBtn.disabled = false;
                signupBtn.textContent = "Sign Up";
            }
        }

        async function handleGoogleAuth() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const userCredential = await auth.signInWithPopup(provider);
                const user = userCredential.user;
                
                // Check if this is a new user
                const userDoc = await db.collection("users").doc(user.uid).get();
                
                if (!userDoc.exists) {
                    // Create user document for new Google users
                    await db.collection("users").doc(user.uid).set({
                        username: user.displayName || "User",
                        email: user.email,
                        photoURL: user.photoURL,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        streak: 0,
                        lastLoginDate: firebase.firestore.FieldValue.serverTimestamp(),
                        theme: "green"
                    });
                }
                
                // Auth state change will trigger app rendering
            } catch (error) {
                const errorElement = document.getElementById("auth-error");
                errorElement.textContent = error.message;
                errorElement.style.display = "block";
            }
        }

        async function handleGitHubAuth() {
            try {
                const provider = new firebase.auth.GithubAuthProvider();
                const userCredential = await auth.signInWithPopup(provider);
                const user = userCredential.user;
                
                // Check if this is a new user
                const userDoc = await db.collection("users").doc(user.uid).get();
                
                if (!userDoc.exists) {
                    // Create user document for new GitHub users
                    await db.collection("users").doc(user.uid).set({
                        username: user.displayName || "User",
                        email: user.email,
                        photoURL: user.photoURL,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        streak: 0,
                        lastLoginDate: firebase.firestore.FieldValue.serverTimestamp(),
                        theme: "green"
                    });
                }
                
                // Auth state change will trigger app rendering
            } catch (error) {
                const errorElement = document.getElementById("auth-error");
                errorElement.textContent = error.message;
                errorElement.style.display = "block";
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                // Auth state change will trigger login page rendering
            } catch (error) {
                console.error("Error signing out:", error);
            }
        }

        // User Data
        async function loadUserData() {
            try {
                const userDoc = await db.collection("users").doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userStreak = userData.streak || 0;
                    lastLoginDate = userData.lastLoginDate ? userData.lastLoginDate.toDate() : null;
                    selectedTheme = userData.theme || "green";
                    
                    // Update streak if needed
                    updateUserStreak();
                    
                    // Apply theme
                    applyTheme(selectedTheme);
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        async function updateUserStreak() {
            try {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                if (lastLoginDate) {
                    const lastLogin = new Date(lastLoginDate.getFullYear(), lastLoginDate.getMonth(), lastLoginDate.getDate());
                    const dayDifference = Math.floor((today - lastLogin) / (1000 * 60 * 60 * 24));
                    
                    if (dayDifference === 1) {
                        // Consecutive day, increment streak
                        userStreak++;
                    } else if (dayDifference > 1) {
                        // Streak broken, reset to 1 for today
                        userStreak = 1;
                    }
                    // If dayDifference is 0, user already logged in today, keep streak as is
                } else {
                    // First login ever, start streak at 1
                    userStreak = 1;
                }
                
                // Update user document
                await db.collection("users").doc(currentUser.uid).update({
                    streak: userStreak,
                    lastLoginDate: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local state
                lastLoginDate = now;
            } catch (error) {
                console.error("Error updating streak:", error);
            }
        }

        function applyTheme(theme) {
            // Remove any existing theme classes
            document.documentElement.classList.remove("theme-green", "theme-blue", "theme-purple", "theme-red", "theme-orange");
            
            // Add selected theme class
            document.documentElement.classList.add(`theme-${theme}`);
            
            // Update CSS variables based on theme
            const root = document.documentElement;
            
            switch (theme) {
                case "blue":
                    root.style.setProperty("--accent-color", "#2563eb");
                    root.style.setProperty("--accent-hover", "#1d4ed8");
                    root.style.setProperty("--gradient-start", "#2563eb");
                    root.style.setProperty("--gradient-end", "#1d4ed8");
                    break;
                case "purple":
                    root.style.setProperty("--accent-color", "#8b5cf6");
                    root.style.setProperty("--accent-hover", "#7c3aed");
                    root.style.setProperty("--gradient-start", "#8b5cf6");
                    root.style.setProperty("--gradient-end", "#7c3aed");
                    break;
                case "red":
                    root.style.setProperty("--accent-color", "#ef4444");
                    root.style.setProperty("--accent-hover", "#dc2626");
                    root.style.setProperty("--gradient-start", "#ef4444");
                    root.style.setProperty("--gradient-end", "#dc2626");
                    break;
                case "orange":
                    root.style.setProperty("--accent-color", "#f97316");
                    root.style.setProperty("--accent-hover", "#ea580c");
                    root.style.setProperty("--gradient-start", "#f97316");
                    root.style.setProperty("--gradient-end", "#ea580c");
                    break;
                default: // green
                    root.style.setProperty("--accent-color", "#10a37f");
                    root.style.setProperty("--accent-hover", "#0d8c6d");
                    root.style.setProperty("--gradient-start", "#10a37f");
                    root.style.setProperty("--gradient-end", "#0d8c6d");
            }
        }

        async function updateUserTheme(theme) {
            try {
                selectedTheme = theme;
                
                // Apply theme immediately
                applyTheme(theme);
                
                // Update user document
                await db.collection("users").doc(currentUser.uid).update({
                    theme: theme
                });
            } catch (error) {
                console.error("Error updating theme:", error);
            }
        }

        // Main App Rendering
        function renderMainApp() {
            appContainer.innerHTML = `
                <div class="app-container">
                    <!-- Sidebar with chat history -->
                    <aside class="sidebar">
                        <div class="sidebar-header">
                            <button class="new-chat-btn">
                                <span>New chat</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                            </button>
                            <button class="toggle-theme-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                            </button>
                        </div>
                        <div class="chat-history">
                            <!-- Chat history will be populated here -->
                        </div>
                        <div class="user-profile">
                            <div class="user-avatar">
                                ${currentUser.photoURL ? `<img src="${currentUser.photoURL}" alt="${currentUser.displayName || 'User'}" />` : currentUser.displayName?.charAt(0) || 'U'}
                            </div>
                            <div class="user-info">
                                <div class="user-name">${currentUser.displayName || currentUser.email}</div>
                                <div class="user-streak">
                                    <span class="streak-flame">🔥</span>
                                    <span>${userStreak} day streak</span>
                                </div>
                            </div>
                            <div class="user-actions">
                                <button class="user-action-btn" id="settings-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                </button>
                                <button class="user-action-btn" id="logout-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="  stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                                </button>
                            </div>
                        </div>
                    </aside>

                    <!-- Main chat area -->
                    <main class="chat-container">
                        <div class="chat-header">
                            <button class="toggle-sidebar-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg>
                            </button>
                            <h1>Code Mate</h1>
                        </div>
                        
                        <div class="messages-container">
                            <!-- Messages will be displayed here -->
                            <div class="welcome-message">
                                <h2>How can I help you today?</h2>
                                <div class="suggestion-chips">
                                    <button class="suggestion-chip">Tell me a joke</button>
                                    <button class="suggestion-chip">Write a poem</button>
                                    <button class="suggestion-chip">Explain quantum physics</button>
                                    <button class="suggestion-chip">Help with coding</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-container">
                            <div class="input-box">
                                <textarea id="user-input" placeholder="Message Code Mate..."></textarea>
                                <div class="input-buttons">
                                    <button class="voice-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line></svg>
                                    </button>
                                    <button class="upload-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-paperclip"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                    </button>
                                    <button class="send-btn" disabled>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4Z"></path><path d="M22 2 11 13"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="disclaimer">
                                Code Mate can make mistakes. Consider checking important information.
                            </div>
                        </div>
                    </main>
                </div>

                <!-- File upload modal -->
                <div class="modal" id="file-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Upload File</h2>
                            <button class="close-modal-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="file-drop-area">
                                <span class="file-msg">Drag & drop files here or click to browse</span>
                                <input class="file-input" type="file" multiple>
                            </div>
                            <div class="file-list">
                                <!-- Uploaded files will appear here -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="cancel-upload-btn">Cancel</button>
                            <button class="confirm-upload-btn">Upload</button>
                        </div>
                    </div>
                </div>

                <!-- Delete confirmation modal -->
                <div class="modal" id="delete-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Delete Chat</h2>
                            <button class="close-delete-modal-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this chat? This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="cancel-delete-btn">Cancel</button>
                            <button class="confirm-delete-btn">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- Settings modal -->
                <div class="modal" id="settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Settings</h2>
                            <button class="close-settings-modal-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="settings-section">
                                <h3>Appearance</h3>
                                <div class="settings-option">
                                    <div>
                                        <div class="settings-option-label">Dark Mode</div>
                                        <div class="settings-option-description">Switch between light and dark themes</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="dark-mode-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="settings-option">
                                    <div>
                                        <div class="settings-option-label">Theme Color</div>
                                        <div class="settings-option-description">Choose your preferred accent color</div>
                                    </div>
                                    <div class="color-themes">
                                        <div class="color-theme color-theme-green active" data-theme="green"></div>
                                        <div class="color-theme color-theme-blue" data-theme="blue"></div>
                                        <div class="color-theme color-theme-purple" data-theme="purple"></div>
                                        <div class="color-theme color-theme-red" data-theme="red"></div>
                                        <div class="color-theme color-theme-orange" data-theme="orange"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-section">
                                <h3>Chat Settings</h3>
                                <div class="settings-option">
                                    <div>
                                        <div class="settings-option-label">Code Execution</div>
                                        <div class="settings-option-description">Allow running code snippets in the chat</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="code-execution-toggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="settings-option">
                                    <div>
                                        <div class="settings-option-label">Voice Input</div>
                                        <div class="settings-option-description">Enable voice-to-text for messages</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="voice-input-toggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="settings-section">
                                <h3>Account</h3>
                                <div class="settings-option">
                                    <div>
                                        <div class="settings-option-label">Email</div>
                                        <div class="settings-option-description">${currentUser.email}</div>
                                    </div>
                                </div>
                                <div class="settings-option">
                                    <div>
                                        <div class="settings-option-label">Username</div>
                                        <div class="settings-option-description">${currentUser.displayName || 'Not set'}</div>
                                    </div>
                                    <button class="auth-link" id="edit-profile-btn">Edit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Share chat modal -->
                <div class="modal" id="share-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Share Chat</h2>
                            <button class="close-share-modal-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Share this chat with others using the link below:</p>
                            <div class="share-link-container">
                                <input type="text" class="share-link-input" id="share-link-input" readonly>
                                <button class="share-link-copy" id="copy-share-link">Copy</button>
                            </div>
                            <div class="share-options">
                                <button class="share-option" id="share-twitter">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"></path></svg>
                                    Twitter
                                </button>
                                <button class="share-option" id="share-facebook">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
                                    Facebook
                                </button>
                                <button class="share-option" id="share-linkedin">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
                                    LinkedIn
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners
            setupEventListeners();
            
            // Load chat history
            loadChatHistory();
            
            // Start a new chat if no chat is selected
            if (!currentChatId) {
                startNewChat();
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Chat input
            const userInput = document.getElementById("user-input");
            const sendBtn = document.querySelector(".send-btn");
            
            userInput.addEventListener("input", () => {
                sendBtn.disabled = !userInput.value.trim();
                autoResizeTextarea(userInput);
            });
            
            userInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    if (userInput.value.trim()) {
                        sendMessage();
                    }
                }
            });
            
            sendBtn.addEventListener("click", sendMessage);
            
            // New chat
            document.querySelector(".new-chat-btn").addEventListener("click", startNewChat);
            
            // Theme toggle
            document.querySelector(".toggle-theme-btn").addEventListener("click", toggleTheme);
            
            // Sidebar toggle (mobile)
            document.querySelector(".toggle-sidebar-btn").addEventListener("click", toggleSidebar);
            
            // File upload
            document.querySelector(".upload-btn").addEventListener("click", openFileModal);
            document.querySelector(".close-modal-btn").addEventListener("click", closeFileModal);
            document.querySelector(".cancel-upload-btn").addEventListener("click", closeFileModal);
            document.querySelector(".confirm-upload-btn").addEventListener("click", handleFileUpload);
            
            const fileDropArea = document.querySelector(".file-drop-area");
            const fileInput = document.querySelector(".file-input");
            
            fileDropArea.addEventListener("click", () => fileInput.click());
            fileInput.addEventListener("change", handleFileSelection);
            
            // Setup drag and drop for file upload
            setupDragAndDrop();
            
            // Delete chat
            document.querySelector(".close-delete-modal-btn").addEventListener("click", closeDeleteModal);
            document.querySelector(".cancel-delete-btn").addEventListener("click", closeDeleteModal);
            document.querySelector(".confirm-delete-btn").addEventListener("click", confirmDeleteChat);
            
            // Settings
            document.getElementById("settings-btn").addEventListener("click", openSettingsModal);
            document.querySelector(".close-settings-modal-btn").addEventListener("click", closeSettingsModal);
            
            // Dark mode toggle in settings
            const darkModeToggle = document.getElementById("dark-mode-toggle");
            darkModeToggle.checked = document.body.classList.contains("dark");
            darkModeToggle.addEventListener("change", toggleTheme);
            
            // Theme color selection
            document.querySelectorAll(".color-theme").forEach(theme => {
                theme.addEventListener("click", () => {
                    const themeColor = theme.getAttribute("data-theme");
                    updateUserTheme(themeColor);
                    
                    // Update active state
                    document.querySelectorAll(".color-theme").forEach(t => {
                        t.classList.remove("active");
                    });
                    theme.classList.add("active");
                });
            });
            
            // Voice input
            const voiceBtn = document.querySelector(".voice-btn");
            voiceBtn.addEventListener("click", toggleVoiceInput);
            
            // Logout
            document.getElementById("logout-btn").addEventListener("click", handleLogout);
            
            // Suggestion chips
            document.querySelectorAll(".suggestion-chip").forEach(chip => {
                chip.addEventListener("click", () => {
                    userInput.value = chip.textContent;
                    sendBtn.disabled = false;
                    sendMessage();
                });
            });
        }

        // Chat Functions
        async function sendMessage() {
            const userInput = document.getElementById("user-input");
            const messagesContainer = document.querySelector(".messages-container");
            
            if (isTyping) return;
            
            const message = userInput.value.trim();
            if (!message) return;
            
            // Clear welcome message if present
            const welcomeMessage = document.querySelector(".welcome-message");
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            // Clear any previous error messages
            const errorMessage = document.querySelector(".error-message");
            if (errorMessage) {
                errorMessage.remove();
            }
            
            // Add user message to UI
            addMessageToUI("user", message);
            
            // Save message to local storage
            saveMessageToLocalStorage("user", message);
            
            // Clear input
            userInput.value = "";
            userInput.style.height = "auto";
            document.querySelector(".send-btn").disabled = true;
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Get AI response
                const aiResponse = await getAIResponse(message);
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Add AI response to UI with feedback buttons
                addMessageToUI("assistant", aiResponse, message);
                
                // Save AI response to local storage
                saveMessageToLocalStorage("assistant", aiResponse);
                
                // Update chat history
                updateChatHistoryItem(currentChatId);
            } catch (error) {
                console.error("Error:", error);
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Show error message
                const errorDiv = document.createElement("div");
                errorDiv.className = "error-message";
                errorDiv.textContent = "Failed to get response from the AI. Please try again.";
                messagesContainer.appendChild(errorDiv);
            }
        }

        // Fixed AI response function that doesn't rely on external API
        async function getAIResponse(message) {
            // Create a simulated delay to mimic API call
            await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
            
            // Simple response logic based on message content
            if (message.toLowerCase().includes("hello") || message.toLowerCase().includes("hi")) {
                return "Hello! How can I help you with your coding questions today?";
            } else if (message.toLowerCase().includes("joke")) {
                return "Why do programmers prefer dark mode? Because light attracts bugs!";
            } else if (message.toLowerCase().includes("poem")) {
                return "In lines of code, we find our way,\nThrough logic's maze, day by day.\nDebugging errors, fixing flaws,\nCreating worlds with syntax laws.";
            } else if (message.toLowerCase().includes("quantum")) {
                return "Quantum physics explores the behavior of matter and energy at the smallest scales. Key concepts include:\n\n- Wave-particle duality\n- Quantum entanglement\n- Superposition\n- Heisenberg's uncertainty principle\n\nWould you like me to explain any of these concepts in more detail?";
            } else if (message.toLowerCase().includes("code") || message.toLowerCase().includes("javascript") || message.toLowerCase().includes("function")) {
                return "Here's a simple JavaScript function that checks if a number is prime:\n\n```javascript\nfunction isPrime(num) {\n  if (num <= 1) return false;\n  if (num <= 3) return true;\n  \n  if (num % 2 === 0 || num % 3 === 0) return false;\n  \n  for (let i = 5; i * i <= num; i += 6) {\n    if (num % i === 0 || num % (i + 2) === 0) return false;\n  }\n  \n  return true;\n}\n\n// Example usage\nconsole.log(isPrime(17)); // true\nconsole.log(isPrime(15)); // false\n```";
            } else {
                return "I'm here to help with your coding questions. You can ask me about programming concepts, debugging issues, or even request code examples. What would you like to learn about today?";
            }
        }

        function addMessageToUI(role, content, query = null) {
            const messagesContainer = document.querySelector(".messages-container");
            const messageDiv = document.createElement("div");
            messageDiv.className = `message message-${role === "user" ? "user" : "ai"}`;
            
            // Create a content container for formatting
            const contentDiv = document.createElement("div");
            contentDiv.className = "message-content";
            
            // Format the content with bullet points and code blocks
            contentDiv.innerHTML = formatMessageContent(content);
            
            messageDiv.appendChild(contentDiv);
            
            // Add feedback buttons for AI responses that contain code
            if (role === "assistant" && containsCode(content)) {
                const feedbackContainer = document.createElement("div");
                feedbackContainer.className = "feedback-container";
                feedbackContainer.innerHTML = `
                    <button class="feedback-btn positive" onclick="sendFeedback('${escapeJsString(query)}', '${escapeJsString(content)}', 1)">👍</button>
                    <button class="feedback-btn negative" onclick="sendFeedback('${escapeJsString(query)}', '${escapeJsString(content)}', -1)">👎</button>
                `;
                messageDiv.appendChild(feedbackContainer);
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Add event listeners to code blocks
            setupCodeBlockInteractions(messageDiv);
        }

        function setupCodeBlockInteractions(messageDiv) {
            // Add event listeners to copy buttons
            const copyButtons = messageDiv.querySelectorAll(".copy-btn");
            copyButtons.forEach(btn => {
                btn.addEventListener("click", handleCopyCode);
            });
            
            // Add event listeners to run code buttons
            const runButtons = messageDiv.querySelectorAll(".run-code-btn");
            runButtons.forEach(btn => {
                btn.addEventListener("click", handleRunCode);
            });
        }

        function handleCopyCode(e) {
            const codeId = e.target.getAttribute("data-code-id");
            const codeElement = document.getElementById(codeId);
            
            if (codeElement) {
                const codeText = codeElement.textContent;
                
                // Copy to clipboard
                navigator.clipboard.writeText(codeText)
                    .then(() => {
                        // Show copied state
                        e.target.classList.add("copied");
                        e.target.textContent = "Copied!";
                        
                        // Reset after 2 seconds
                        setTimeout(() => {
                            e.target.classList.remove("copied");
                            e.target.textContent = "Copy";
                        }, 2000);
                    })
                    .catch(err => {
                        console.error("Failed to copy text: ", err);
                    });
            }
        }

        function handleRunCode(e) {
            const codeId = e.target.getAttribute("data-code-id");
            const codeElement = document.getElementById(codeId);
            const codeContainer = codeElement.closest(".code-container");
            
            // Get or create output element
            let outputElement = codeContainer.querySelector(".code-output");
            if (!outputElement) {
                outputElement = document.createElement("div");
                outputElement.className = "code-output";
                codeContainer.appendChild(outputElement);
            }
            
            // Show output element
            outputElement.style.display = "block";
            outputElement.textContent = "Running code...";
            
            // Get code text
            const codeText = codeElement.textContent;
            
            // Execute code safely
            try {
                // Create a safe execution environment
                const originalConsoleLog = console.log;
                const originalConsoleError = console.error;
                const originalConsoleWarn = console.warn;
                const originalConsoleInfo = console.info;
                
                let output = "";
                
                // Override console methods
                console.log = (...args) => {
                    output += args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(" ") + "\n";
                    originalConsoleLog(...args);
                };
                
                console.error = (...args) => {
                    output += "ERROR: " + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(" ") + "\n";
                    originalConsoleError(...args);
                };
                
                console.warn = (...args) => {
                    output += "WARNING: " + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(" ") + "\n";
                    originalConsoleWarn(...args);
                };
                
                console.info = (...args) => {
                    output += "INFO: " + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(" ") + "\n";
                    originalConsoleInfo(...args);
                };
                
                // Execute the code
                const result = new Function(codeText)();
                
                // Restore console methods
                console.log = originalConsoleLog;
                console.error = originalConsoleError;
                console.warn = originalConsoleWarn;
                console.info = originalConsoleInfo;
                
                // Display output
                if (output) {
                    outputElement.textContent = output;
                } else if (result !== undefined) {
                    outputElement.textContent = result;
                } else {
                    outputElement.textContent = "Code executed successfully with no output.";
                }
            } catch (error) {
                outputElement.textContent = "Error: " + error.message;
            }
        }

        // Format message content with bullet points and code blocks
        function formatMessageContent(content) {
            // Check if content contains code
            if (containsCode(content)) {
                return formatCodeBlock(content);
            }
            
            // Format bullet points
            let formattedContent = content;
            
            // Convert lines starting with - or * to bullet points
            if (content.includes("\n- ") || content.includes("\n* ") || content.startsWith("- ") || content.startsWith("* ")) {
                const lines = content.split("\n");
                let inList = false;
                let html = "";
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    if (line.trim().startsWith("- ") || line.trim().startsWith("* ")) {
                        if (!inList) {
                            html += "<ul>";
                            inList = true;
                        }
                        html += `<li>${line.trim().substring(2)}</li>`;
                    } else {
                        if (inList) {
                            html += "</ul>";
                            inList = false;
                        }
                        html += `<p>${line}</p>`;
                    }
                }
                
                if (inList) {
                    html += "</ul>";
                }
                
                return html;
            }
            
            // Format numbered lists
            if (content.includes("\n1. ") || content.startsWith("1. ")) {
                const lines = content.split("\n");
                let inList = false;
                let html = "";
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const numberMatch = line.trim().match(/^(\d+)\.\s(.*)/)
                    
                    if (numberMatch) {
                        if (!inList) {
                            html += "<ol>";
                            inList = true;
                        }
                        html += `<li>${numberMatch[2]}</li>`;
                    } else {
                        if (inList) {
                            html += "</ol>";
                            inList = false;
                        }
                        html += `<p>${line}</p>`;
                    }
                }
                
                if (inList) {
                    html += "</ol>";
                }
                
                return html;
            }
            
            // If no special formatting, wrap in paragraph
            return `<p>${content}</p>`;
        }
        
        // Check if content contains code
        function containsCode(content) {
            return content.includes("```") || 
                   content.includes("function ") || 
                   content.includes("const ") || 
                   content.includes("let ") || 
                   content.includes("var ") ||
                   content.includes("class ") ||
                   content.includes("import ") ||
                   content.includes("for (") ||
                   content.includes("if (");
        }
        
        // Format code blocks
        function formatCodeBlock(content) {
            // Check for code blocks with backticks
            if (content.includes("```")) {
                let html = "";
                const parts = content.split("```");
                
                for (let i = 0; i < parts.length; i++) {
                    if (i % 2 === 0) {
                        // Text content
                        if (parts[i].trim()) {
                            html += `<p>${parts[i]}</p>`;
                        }
                    } else {
                        // Code content
                        let code = parts[i];
                        let language = "javascript";
                        
                        // Check if language is specified
                        const firstLineBreak = code.indexOf("\n");
                        if (firstLineBreak > 0) {
                            const possibleLang = code.substring(0, firstLineBreak).trim();
                            if (possibleLang && !possibleLang.includes(" ")) {
                                language = possibleLang;
                                code = code.substring(firstLineBreak + 1);
                            }
                        }
                        
                        html += createCodeBlockHTML(code, language);
                    }
                }
                
                return html;
            }
            
            // Detect inline code
            if (containsCode(content)) {
                return createCodeBlockHTML(content, "javascript");
            }
            
            return `<p>${content}</p>`;
        }
        
        // Create HTML for code block with copy and run buttons
        function createCodeBlockHTML(code, language) {
            const codeId = "code-" + generateId();
            const isJavaScript = language === "javascript" || language === "js";
            
            return `
                <div class="code-container">
                    <div class="code-header">
                        <span class="language-tag">${language}</span>
                        <div class="code-header-actions">
                            <button class="copy-btn" data-code-id="${codeId}">Copy</button>
                            ${isJavaScript ? `<button class="run-code-btn" data-code-id="${codeId}">Run</button>` : ''}
                        </div>
                    </div>
                    <pre class="code-block" id="${codeId}">${escapeHtml(code.trim())}</pre>
                </div>
            `;
        }
        
        // Escape HTML special characters
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Escape string for JavaScript
        function escapeJsString(str) {
            if (!str) return '';
            return str.replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/"/g, '\\"')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '\\r')
                    .replace(/\t/g, '\\t');
        }

        function showTypingIndicator() {
            isTyping = true;
            const messagesContainer = document.querySelector(".messages-container");
            const typingDiv = document.createElement("div");
            typingDiv.className = "typing-indicator";
            typingDiv.innerHTML = "<span></span><span></span><span></span>";
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            isTyping = false;
            const typingIndicator = document.querySelector(".typing-indicator");
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function startNewChat() {
            // If there's a current chat with messages, save it before starting a new one
            if (currentChatId && chatMessages[currentChatId] && chatMessages[currentChatId].length > 0) {
                // Current chat already exists and has messages
                // We don't need to do anything special here as it's already saved
            }
            
            // Create a new chat ID
            currentChatId = generateId();
            
            // Initialize empty messages array for this chat
            chatMessages[currentChatId] = [];
            
            // Add this chat to the chats array
            chats.unshift({
                id: currentChatId,
                title: "New Chat",
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            });
            
            // Save to local storage
            saveLocalChats();
            
            // Clear messages container
            const messagesContainer = document.querySelector(".messages-container");
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <h2>How can I help you today?</h2>
                    <div class="suggestion-chips">
                        <button class="suggestion-chip">Tell me a joke</button>
                        <button class="suggestion-chip">Write a poem</button>
                        <button class="suggestion-chip">Explain quantum physics</button>
                        <button class="suggestion-chip">Help with coding</button>
                    </div>
                </div>
            `;

            // Setup suggestion chips again
            document.querySelectorAll(".suggestion-chip").forEach((chip) => {
                chip.addEventListener("click", () => {
                    document.getElementById("user-input").value = chip.textContent;
                    document.querySelector(".send-btn").disabled = false;
                    sendMessage();
                });
            });
            
            // Update chat history
            loadChatHistory();
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.querySelector(".sidebar").classList.remove("show");
            }
        }

        function toggleTheme() {
            document.body.classList.toggle("dark");
            
            // Update toggle in settings if it exists
            const darkModeToggle = document.getElementById("dark-mode-toggle");
            if (darkModeToggle) {
                darkModeToggle.checked = document.body.classList.contains("dark");
            }
            
            // Update theme icon
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.body.classList.contains("dark");
            const toggleThemeBtn = document.querySelector(".toggle-theme-btn");
            
            toggleThemeBtn.innerHTML = isDark
                ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>';
        }

        function toggleSidebar() {
            document.querySelector(".sidebar").classList.toggle("show");
        }

        // File Upload Functions
        function openFileModal() {
            document.getElementById("file-modal").classList.add("show");
            uploadedFiles = [];
            renderFileList();
        }

        function closeFileModal() {
            document.getElementById("file-modal").classList.remove("show");
        }

        function handleFileSelection(e) {
            const files = e.target.files;
            processFiles(files);
        }

        function processFiles(files) {
            for (let i = 0; i < files.length; i++) {
                uploadedFiles.push(files[i]);
            }
            renderFileList();
        }

        function renderFileList() {
            const fileList = document.querySelector(".file-list");
            fileList.innerHTML = "";
            
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement("div");
                fileItem.className = "file-item";
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <button class="remove-file-btn" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });

            // Add event listeners to remove buttons
            document.querySelectorAll(".remove-file-btn").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    const index = Number.parseInt(e.currentTarget.dataset.index);
                    uploadedFiles.splice(index, 1);
                    renderFileList();
                });
            });
        }

        async function handleFileUpload() {
            if (uploadedFiles.length === 0) return;

            // Add file message to chat
            const fileNames = uploadedFiles.map((file) => file.name).join(", ");
            const fileMessage = `Uploaded files: ${fileNames}`;
            
            // Add message to UI
            addMessageToUI("user", fileMessage);
            
            // Save message to local storage
            saveMessageToLocalStorage("user", fileMessage);

            // Close modal
            closeFileModal();

            // Show typing indicator
            showTypingIndicator();

            // Simulate AI response after a delay
            setTimeout(async () => {
                const aiResponse = `I've received your files (${fileNames}). What would you like me to do with them?`;
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Add AI response to UI
                addMessageToUI("assistant", aiResponse, fileMessage);
                
                // Save AI response to local storage
                saveMessageToLocalStorage("assistant", aiResponse);
                
                // Update chat history
                updateChatHistoryItem(currentChatId);
            }, 1500 + Math.random() * 1000);
        }

        function setupDragAndDrop() {
            const fileDropArea = document.querySelector(".file-drop-area");
            
            ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
                fileDropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ["dragenter", "dragover"].forEach((eventName) => {
                fileDropArea.addEventListener(eventName, highlight, false);
            });
            
            ["dragleave", "drop"].forEach((eventName) => {
                fileDropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                fileDropArea.classList.add("highlight");
            }

            function unhighlight() {
                fileDropArea.classList.remove("highlight");
            }

            fileDropArea.addEventListener("drop", handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                processFiles(files);
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = "auto";
            textarea.style.height = textarea.scrollHeight + "px";
        }

        // Voice Input
        function toggleVoiceInput() {
            const voiceBtn = document.querySelector(".voice-btn");
            const userInput = document.getElementById("user-input");
            
            if (voiceBtn.classList.contains("recording")) {
                // Stop recording
                voiceBtn.classList.remove("recording");
                stopVoiceRecognition();
            } else {
                // Start recording
                voiceBtn.classList.add("recording");
                startVoiceRecognition();
            }
        }

        let recognition = null;

        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Your browser doesn't support speech recognition. Try Chrome or Edge.");
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onresult = (event) => {
                const userInput = document.getElementById("user-input");
                let transcript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                
                userInput.value = transcript;
                document.querySelector(".send-btn").disabled = !transcript.trim();
                autoResizeTextarea(userInput);
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                stopVoiceRecognition();
            };
            
            recognition.onend = () => {
                document.querySelector(".voice-btn").classList.remove("recording");
            };
            
            recognition.start();
        }

        function stopVoiceRecognition() {
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
        }

        // Settings Modal
        function openSettingsModal() {
            const settingsModal = document.getElementById("settings-modal");
            settingsModal.classList.add("show");
            
            // Set active theme
            document.querySelectorAll(".color-theme").forEach(theme => {
                theme.classList.remove("active");
                if (theme.getAttribute("data-theme") === selectedTheme) {
                    theme.classList.add("active");
                }
            });
        }

        function closeSettingsModal() {
            document.getElementById("settings-modal").classList.remove("show");
        }

        // Local Storage Functions
        function loadChatHistory() {
            const chatHistory = document.querySelector(".chat-history");
            chatHistory.innerHTML = "";
            
            if (chats.length === 0) {
                return;
            }
            
            chats.forEach(chat => {
                const historyItem = document.createElement("div");
                historyItem.className = "history-item";
                historyItem.dataset.chatId = chat.id;
                
                // Add active class if this is the current chat
                if (chat.id === currentChatId) {
                    historyItem.classList.add("active");
                }
                
                historyItem.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    <span class="history-item-title">${chat.title}</span>
                    <button class="delete-chat-btn" data-chat-id="${chat.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg>
                    </button>
                `;
                
                historyItem.addEventListener("click", (e) => {
                    // Don't load chat if delete button was clicked
                    if (e.target.closest(".delete-chat-btn")) return;
                    loadChat(chat.id);
                });
                
                // Add event listener to delete button
                const deleteBtn = historyItem.querySelector(".delete-chat-btn");
                deleteBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    openDeleteModal(chat.id);
                });
                
                chatHistory.appendChild(historyItem);
            });
        }

        function saveMessageToLocalStorage(role, content) {
            if (!currentChatId) {
                currentChatId = generateId();
                chats.unshift({
                    id: currentChatId,
                    title: "New Chat",
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                chatMessages[currentChatId] = [];
            }
            
            // Add message to messages array
            const message = {
                role,
                content,
                timestamp: new Date().toISOString()
            };
            
            if (!chatMessages[currentChatId]) {
                chatMessages[currentChatId] = [];
            }
            
            chatMessages[currentChatId].push(message);
            
            // Update chat title if this is the first user message
            if (chatMessages[currentChatId].length === 1 && role === "user") {
                const title = content.length > 30 ? content.substring(0, 30) + "..." : content;
                
                // Find the chat and update its title
                const chatIndex = chats.findIndex(chat => chat.id === currentChatId);
                if (chatIndex !== -1) {
                    chats[chatIndex].title = title;
                    chats[chatIndex].updatedAt = new Date().toISOString();
                }
            } else {
                // Just update the timestamp
                const chatIndex = chats.findIndex(chat => chat.id === currentChatId);
                if (chatIndex !== -1) {
                    chats[chatIndex].updatedAt = new Date().toISOString();
                }
            }
            
            // Save to local storage
            saveLocalChats();
            
            // Update chat history
            loadChatHistory();
        }

        function loadChat(chatId) {
            // Save current chat if needed
            if (currentChatId && currentChatId !== chatId) {
                // Current chat is already saved in local storage
            }
            
            currentChatId = chatId;
            const messagesContainer = document.querySelector(".messages-container");
            messagesContainer.innerHTML = "";
            
            // Show loading indicator
            const loadingDiv = document.createElement("div");
            loadingDiv.className = "typing-indicator";
            loadingDiv.innerHTML = "<span></span><span></span><span></span>";
            messagesContainer.appendChild(loadingDiv);
            
            // Get messages for this chat
            const messages = chatMessages[chatId] || [];
            
            // Remove loading indicator
            loadingDiv.remove();
            
            if (messages.length === 0) {
                // No messages yet
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <h2>How can I help you today?</h2>
                        <div class="suggestion-chips">
                            <button class="suggestion-chip">Tell me a joke</button>
                            <button class="suggestion-chip">Write a poem</button>
                            <button class="suggestion-chip">Explain quantum physics</button>
                            <button class="suggestion-chip">Help with coding</button>
                        </div>
                    </div>
                `;
                
                // Setup suggestion chips again
                document.querySelectorAll(".suggestion-chip").forEach((chip) => {
                    chip.addEventListener("click", () => {
                        document.getElementById("user-input").value = chip.textContent;
                        document.querySelector(".send-btn").disabled = false;
                        sendMessage();
                    });
                });
                
                return;
            }
            
            // Render messages
            let previousUserMessage = null;
            
            messages.forEach(message => {
                // For AI messages, we need the previous user message for feedback
                if (message.role === "assistant" && previousUserMessage) {
                    addMessageToUI(message.role, message.content, previousUserMessage);
                    previousUserMessage = null;
                } else {
                    addMessageToUI(message.role, message.content);
                    
                    if (message.role === "user") {
                        previousUserMessage = message.content;
                    }
                }
            });
            
            // Update chat history to highlight current chat
            loadChatHistory();
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.querySelector(".sidebar").classList.remove("show");
            }
        }

        function updateChatHistoryItem(chatId) {
            // Just reload the entire chat history for simplicity
            loadChatHistory();
        }

        function openDeleteModal(chatId) {
            chatToDelete = chatId;
            document.getElementById("delete-modal").classList.add("show");
        }

        function closeDeleteModal() {
            document.getElementById("delete-modal").classList.remove("show");
            chatToDelete = null;
        }

        function confirmDeleteChat() {
            if (!chatToDelete) return;
            
            // Find the chat index
            const chatIndex = chats.findIndex(chat => chat.id === chatToDelete);
            if (chatIndex !== -1) {
                // Remove the chat from the chats array
                chats.splice(chatIndex, 1);
                
                // Remove the chat messages
                delete chatMessages[chatToDelete];
                
                // Save to local storage
                saveLocalChats();
                
                // If current chat was deleted, start a new one
                if (chatToDelete === currentChatId) {
                    if (chats.length > 0) {
                        // Load the first chat
                        currentChatId = chats[0].id;
                        loadChat(currentChatId);
                    } else {
                        // No chats left, start a new one
                        startNewChat();
                    }
                }
                
                // Update chat history
                loadChatHistory();
            }
            
            // Close modal
            closeDeleteModal();
        }

        // Helper Functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // Feedback Function
        window.sendFeedback = async function(query, response, rating) {
            try {
                // Visual feedback
                const feedbackBtns = document.querySelectorAll(".feedback-btn");
                feedbackBtns.forEach(btn => {
                    if ((rating === 1 && btn.classList.contains("positive")) || 
                        (rating === -1 && btn.classList.contains("negative"))) {
                        btn.classList.add("active");
                    } else {
                        btn.classList.remove("active");
                    }
                });

                // Show alert to confirm feedback submission
                alert("Feedback submitted successfully!");

            } catch (error) {
                console.error("Error sending feedback:", error);
                alert("Failed to submit feedback. Please try again.");
            }
        };
    </script>
</body>
</html>

